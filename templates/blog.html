{% extends 'base.html' %}

{% block head %}
    <script>
        $(window).on('scroll', () => ajax_request())

        let lowestScrollPos = 0;
        let currentHeight = 0;
        let blog_id = 1;
        let max_article_reached = false;
        let posts_in_queue = 0
        let ajax_is_processing = false;
        let route = "{{ route }}";

        $.ajaxSetup({ 
			beforeSend: (xhr, settings) => {
				if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token() }}"); 
			} 
        });

        ajax_request = () => {
            posts_in_queue++;
            if (!ajax_is_processing) ajax_manager();
        }
        
        ajax_manager = async () => {
            ajax_is_processing = true;
            while (posts_in_queue>0) {
                await check_ajax_height();
                posts_in_queue--;
            }
            ajax_is_processing = false;
        }

        check_ajax_height = async () => {
            if (!max_article_reached) {
                lowestScrollPos = document.documentElement.scrollTop>lowestScrollPos?document.documentElement.scrollTop:lowestScrollPos;
                if (lowestScrollPos+(2*$(window).height())>currentHeight) {
                    await $.post(route, "blog_id="+blog_id).done(response => {
                        if (response.article) {
                            let url_author = "{{ url_for('blog_user_query', username='name1') }}".replace("name1", response.posted_by)
                            let url_date = "{{ url_for('blog_date_query', day=5000, month=5000, year=5000) }}".replace("5000", response.day).replace("5000", response.month).replace("5000", response.year)
                            $("#content").html( 
                                $("#content").html().replace( 
                                    /<!-- replace position for new blogs -->/g, `
                                        <article id='article_${ blog_id }'>
                                            <h2>${ response.caption }</h2>
                                            <span>Ver√∂ffentlicht am <a href="${url_date}">${ response.date_created }</a> von <a href="${url_author}">${ response.posted_by }</a></span>
                                            <p>${ compile(response.body) }</p>
                                        </article>
                                        \n
                                        \n
                                        <!-- replace position for new blogs -->\n` 
                                )
                            )
                            currentHeight += $(`#article_${ blog_id }`).height()
                            blog_id++;
                            ajax_request();
                        } else {
                            $("#blog_loading_article").remove();
                            max_article_reached = true;
                        }
                    }).fail(() => console.log('Error: Could not contact server.'));
                }
            }
        }

        compile = input => {
            let style_conv = input
                            .replace( /\[fat]/g, '<span class="fat_span">' ).replace(  /\[\/fat]/g, '</span>'  )
                            .replace( /\[italic]/g, '<span class="italic_span">' ).replace(  /\[\/italic]/g, '</span>'  )
                            .replace( /\[underline]/g, '<span class="underlined_span">' ).replace(  /\[\/underline]/g, '</span>'  )
            let link_count = style_conv.split("[link]").length
            for (i=0; i<=link_count; i++) {
                link_start = style_conv.search(/\[link]/)+6;
                link_end = style_conv.search(/\[\/link]/);
                link_string = style_conv.substring(link_start, link_end);
                style_conv = style_conv.replace(/\[link]/, '<a class="link_span" href="').replace(/\[\/link]/, '">'+link_string+'</a>')
            }
            return style_conv;                                                   
        }

        ajax_request();
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/parse_styling.css') }}">
{% endblock %}

{% block content %} 
	<article>
    <h2>{{ title }}</h2>

    {% if post_count == 0 %}
        <p>There are no Blogposts available!</p>
    {% endif %}
    </article>
    
    <!-- replace position for new blogs -->

    <article id="blog_loading_article">
        <h2>loading...</h2>
    </article>
	
{% endblock %}