{% extends 'base.html' %}

{% block head %}
    <script>
        $(window).on('scroll', () => ajaxRequest())

        let lowestScrollPos = 0;
        let currentHeight = 0;
        let blogId = 1;
        let maxArticleReached = false;
        let postsInQueue = 0
        let ajaxIsProcessing = false;
        let route = "{{ route }}";

        ajaxRequest = () => {
            postsInQueue++;
            if (!ajaxIsProcessing) ajaxManager();
        }
        
        ajaxManager = async () => {
            ajaxIsProcessing = true;
            while (postsInQueue>0) {
                await checkAjaxHeight();
                postsInQueue--;
            }
            ajaxIsProcessing = false;
        }

        async function checkAjaxHeight() {
            if (!maxArticleReached) {
                lowestScrollPos = Math.max(document.documentElement.scrollTop, lowestScrollPos);
                if (lowestScrollPos+(2*$(window).height())>currentHeight) {
                    await $.post(route, "blog_id="+blogId).done(response => {
                        if (response.article) {
                            const urlAuthor = "{{ url_for('blog_user_query', username='name1') }}".replace("name1", response.posted_by);
                            const urlDate = "{{ url_for('blog_date_query', day=5000, month=5000, year=5000) }}".replace("5000", response.day).replace("5000", response.month).replace("5000", response.year);
                            const urlPostMain = "{{ url_for('blog_post', id=0) }}".replace("0", response.id);
                            $("#content").html( 
                                $("#content").html().replace( 
                                    /<!-- replace position for new blogs -->/g, `
                                    ${ blogId!=1?'<hr />\n\n':'' }
                                    <article id='article_${ blogId }'>\n
                                        <h2><a href="${ urlPostMain }">${ response.caption }</a></h2>\n
                                        <span class="subTitle">Veröffentlicht am <a href="${ urlDate }">${ response.date_created }</a> von <a href="${ urlAuthor }">${ response.posted_by }</a></span><br />\n
										${ response.tags!=''?`<span class="tags">Tags: ${ response.tags }</span>`:'' }\n
                                        <p>${ response.body }</p>\n
                                    </article>
                                    \n
                                    \n
                                    <!-- replace position for new blogs -->\n` 
                                )
                            );
                            currentHeight += $(`#article_${ blogId }`).height();
                            blogId++;
                            if (response.is_main_page) {
                                showComments();
                                commentRequest();
                                $(window).on('scroll', () => {
                                    ajaxRequest();
                                    commentRequest();
                                });
                                stopAjax();
                            }
                            ajaxRequest();
                        } else stopAjax();
                    }).fail(() => openPopup('Verbindung zum Server fehlgeschlagen!', '', ''));
                }
            }
        }

        stopAjax = () => {
            $("#blog_loading_article").remove();
            maxArticleReached = true;
        }

        ajaxRequest();

        function showComments() {
            $('#comments').css('display', 'block');
        }

        function postComment() {
            $.post(route.replace('post', 'post_comment'), $('#comment_form').serialize()).done(response => {
                if (response.redirect) {
                    $('#comment_form textarea').val('');
                    maxCommentReached = false;
                    commentRequest();
                }
                else openPopup(response.text, '', '');
            }).fail(() => openPopup('Verbindung zum Server fehlgeschlagen!', '', ''));
        }

        function deleteComment(commentIdToDelete) {
            $.post(route.replace('post', 'delete_comment'), 'comment_id='+commentIdToDelete).done(response => {
                if (response.comment) removeCommentFromHtml(commentIdToDelete);
            }).fail(() => openPopup('Verbindung zum Server fehlgeschlagen!', '', ''));
        }

        function removeCommentFromHtml(id) {
            $(`#comment_${ id }`).remove();
            let i = id;
            while (true) {
                i++;
                let section = $('#commentSection');
                if ($(`#comment_${ i }`).length == 0) break;
                section.html(section.html().replace(`comment_${ i }`, `comment_${ i-1 }`));
                section.html(section.html().replace(`deleteComment(${ i })`, `deleteComment(${ i-1 })`))
            }
        }

        let commentId = 0;
        let maxCommentReached = false;
        let commentsInQueue = 0;
        let commentAjaxIsProcessing = false;
        let currentCommentHeight = 0;

        function commentRequest() {
            commentsInQueue++;
            if (!commentAjaxIsProcessing) commentRequestManager();
        }
        
        async function commentRequestManager() {
            ajaxIsProcessing = true;
            while (commentsInQueue>0) {
                await getComments();
                commentsInQueue--;
            }
            commentAjaxIsProcessing = false;
        }

        async function getComments() {
            if (!maxCommentReached) {
                lowestScrollPos = Math.max(document.documentElement.scrollTop, lowestScrollPos);
                if (lowestScrollPos+(2*$(window).height())>currentCommentHeight) {
                    $.post(route.replace('post', 'get_comments'), 'comment_id='+commentId).done(response => {
                        if (response.comment) {
                            const urlAuthor = "{{ url_for('blog_user_query', username='name1') }}".replace("name1", response.posted_by);
                            const urlDate = "{{ url_for('blog_date_query', day=5000, month=5000, year=5000) }}".replace("5000", response.day).replace("5000", response.month).replace("5000", response.year);
                            $('#commentSection').append(`
                                <div class='comment' id='comment_${ commentId }'>\n
                                    <span class="subTitle">Kommentiert am <a href="${ urlDate }">${ response.date_created }</a> von <a href="${ urlAuthor }">${ response.posted_by }</a>${'{{ current_user.id }}' == response.author_id ? `<a onclick="deleteComment(${commentId})">Delete</a>` : '' }</span><br />\n
                                    <p>${ response.body }</p>\n
                                </div>\n
                            `);
                            currentCommentHeight += $(`#comment_${ commentId }`).height();
                            commentId++;
                            commentRequest();
                        } else stopCommentAjax();
                    }).fail(() => openPopup('Verbindung zum Server fehlgeschlagen!', '', ''));
                }
            }
        }

        stopCommentAjax = () => {
            $("#comment_loading_div").remove();
            maxCommentReached = true;
        }
    </script>
	<link href="{{ url_for('static', filename='css/blog.css') }}" rel="stylesheet">
{% endblock %}

{% block content %} 
	<article>
    {% if request.path != "/blog" %}
    <a class="button" href="{{ url_for('blog') }}">&larr; Zurück zum Blog</a>
    {% endif %}
    {% if post_count == 0 %}
        <p>Es sind keine Blogposts verfügbar.</p>
    {% endif %}
    </article>

    <!-- replace position for new blogs -->

    <article id="blog_loading_article">
        <h2>Beiträge werden geladen ...</h2>
    </article>
	
    <section id='comments' style="display: none;">
        <hr />
	
        <br />
        <p>Kommentare</p>
        
        <form action="javascript:postComment()" method="post" id="comment_form">
            <textarea name="body" placeholder="Lasse einen Kommentar da"></textarea>
            <button type="submit">Senden</button>
        </form>

        <div id="commentSection">
            <!-- position for comments -->
            {% if comment_count == 0 %} 
                <p>Es sind keine Kommentare verfügbar.</p>
            {% endif %}
        </div>

        <div id='comment_loading_div'>
            <h2>Kommentare werden geladen ...</h2>
        </div>
    </section>
{% endblock %}